<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADALA Agent Architecture Visualization</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            border-bottom: 2px solid #e1e5e9;
            padding-bottom: 20px;
        }
        .header h1 {
            color: #2c3e50;
            margin: 0;
            font-size: 2.5em;
        }
        .header p {
            color: #7f8c8d;
            font-size: 1.2em;
            margin: 10px 0;
        }
        .section {
            margin: 40px 0;
        }
        .section h2 {
            color: #34495e;
            border-left: 4px solid #3498db;
            padding-left: 15px;
            margin-bottom: 20px;
        }
        .mermaid {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }
        .component-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .component-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
        }
        .component-card h3 {
            color: #495057;
            margin-top: 0;
        }
        .feature-list {
            list-style: none;
            padding: 0;
        }
        .feature-list li {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        .feature-list li:last-child {
            border-bottom: none;
        }
        .code-block {
            background: #f4f4f4;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ADALA Agent Architecture</h1>
            <p>Autonomous Data Annotation and Learning Agent - Deep Dive</p>
        </div>

        <div class="section">
            <h2>1. ç³»ç»Ÿæ•´ä½“æ¶æ„</h2>
            <div class="mermaid">
                graph TB
                    subgraph "Agent Core System"
                        A[Agent] --> B[Skill Engine]
                        A --> C[Environment Interface]
                        A --> D[Runtime Manager]
                        A --> E[Memory System]
                    end
                    
                    subgraph "External Dependencies"
                        F[LLM APIs]
                        G[Data Sources]
                        H[Storage Systems]
                    end
                    
                    B --> F
                    C --> G
                    E --> H
                    
                    style A fill:#3498db,stroke:#2980b9,stroke-width:3px
                    style F fill:#e74c3c,stroke:#c0392b
                    style G fill:#2ecc71,stroke:#27ae60
                    style H fill:#f39c12,stroke:#d68910
            </div>
        </div>

        <div class="section">
            <h2>2. ç±»ç»“æ„å›¾</h2>
            <div class="mermaid">
                classDiagram
                    class Agent {
                        -environment Environment
                        -skills SkillSet
                        -memory Memory
                        -runtimes Dict~str, Runtime~
                        -default_runtime str
                        -teacher_runtimes Dict~str, Runtime~
                        -default_teacher_runtime str
                        
                        +run(input runtime **kwargs)
                        +arun(input runtime)
                        +learn(learning_iterations accuracy_threshold)
                        +arefine_skill(skill_name input_variables)
                        +get_runtime(runtime)
                        +get_teacher_runtime(runtime)
                        +select_skill_to_train(feedback threshold)
                    }

                    class Environment {
                        <<interface>>
                        +initialize()
                        +finalize()
                        +get_data_batch(batch_size)
                        +get_feedback(skills predictions num_feedbacks)
                        +save()
                        +restore()
                    }

                    class SkillSet {
                        <<abstract>>
                        -skills Dict~str, Skill~
                        +apply(input runtime improved_skill)
                        +get_skill_outputs()
                        +__getitem__(skill_name)
                    }

                    class LinearSkillSet {
                        -skill_sequence List~str~
                        +apply(input runtime improved_skill)
                    }

                    class Skill {
                        <<abstract>>
                        -name str
                        -instructions str
                        -frozen bool
                        +apply(input runtime)
                        +improve(predictions feedback runtime)
                    }

                    class Runtime {
                        <<abstract>>
                        -verbose bool
                        -batch_size int
                        -concurrency int
                        +record_to_record(record templates)
                        +batch_to_batch(batch templates)
                    }

                    class OpenAIChatRuntime {
                        -model str
                        -api_key str
                        -temperature float
                    }

                    class StaticEnvironment {
                        -df InternalDataFrame
                        +get_data_batch(batch_size)
                        +get_feedback(skills predictions)
                    }

                    Agent --> Environment
                    Agent --> SkillSet
                    Agent --> Runtime
                    LinearSkillSet --|> SkillSet
                    StaticEnvironment ..|> Environment
                    OpenAIChatRuntime ..|> Runtime
            </div>
        </div>

        <div class="section">
            <h2>3. æ ¸å¿ƒç»„ä»¶è¯¦è§£</h2>
            <div class="component-grid">
                <div class="component-card">
                    <h3>ğŸ¯ Agent (æ™ºèƒ½ä½“)</h3>
                    <ul class="feature-list">
                        <li>ğŸ”„ åè°ƒæ‰€æœ‰ç»„ä»¶</li>
                        <li>ğŸ§  ç®¡ç†å­¦ä¹ è¿‡ç¨‹</li>
                        <li>âš¡ æ”¯æŒåŒæ­¥/å¼‚æ­¥æ“ä½œ</li>
                        <li>ğŸ›ï¸ è¿è¡Œæ—¶åŠ¨æ€åˆ‡æ¢</li>
                        <li>ğŸ“Š æ€§èƒ½ç›‘æ§å’Œåé¦ˆ</li>
                    </ul>
                </div>
                
                <div class="component-card">
                    <h3>ğŸ”§ SkillSet (æŠ€èƒ½é›†åˆ)</h3>
                    <ul class="feature-list">
                        <li>ğŸ“‹ ä»»åŠ¡åˆ†è§£å’Œç¼–æ’</li>
                        <li>ğŸ”„ çº¿æ€§/å¹¶è¡Œæ‰§è¡Œæ¨¡å¼</li>
                        <li>ğŸ¯ æŠ€èƒ½ä¾èµ–ç®¡ç†</li>
                        <li>ğŸ“ˆ æ€§èƒ½è·Ÿè¸ª</li>
                        <li>ğŸ” åŠ¨æ€æŠ€èƒ½é€‰æ‹©</li>
                    </ul>
                </div>
                
                <div class="component-card">
                    <h3>ğŸŒ Environment (ç¯å¢ƒ)</h3>
                    <ul class="feature-list">
                        <li>ğŸ“Š æ•°æ®æµç®¡ç†</li>
                        <li>âœ… åé¦ˆæ”¶é›†</li>
                        <li>ğŸ”„ çŠ¶æ€æŒä¹…åŒ–</li>
                        <li>ğŸŒŠ å¼‚æ­¥æ•°æ®æµ</li>
                        <li>ğŸ¯ çœŸå€¼å¯¹æ¯”</li>
                    </ul>
                </div>
                
                <div class="component-card">
                    <h3>âš™ï¸ Runtime (è¿è¡Œæ—¶)</h3>
                    <ul class="feature-list">
                        <li>ğŸ¤– LLMåç«¯æŠ½è±¡</li>
                        <li>ğŸ“Š æ‰¹å¤„ç†ä¼˜åŒ–</li>
                        <li>âš¡ å¹¶è¡Œæ‰§è¡Œ</li>
                        <li>ğŸ’° æˆæœ¬æ§åˆ¶</li>
                        <li>ğŸ”„ å¼‚æ­¥æ”¯æŒ</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="section">
            <h2>4. å­¦ä¹ å¾ªç¯æµç¨‹</h2>
            <div class="mermaid">
                flowchart TD
                    Start([Learning Start]) --> Init[Initialize Runtimes]
                    Init --> Loop[For each iteration]
                    
                    Loop --> Data[Get Data Batch]
                    Data --> Predict[Generate Predictions]
                    Predict --> Feedback[Get Environment Feedback]
                    
                    Feedback --> Check{Has Errors?}
                    Check -->|No| Continue[Continue Loop]
                    Check -->|Yes| Select[Select Skill to Train]
                    
                    Select --> Frozen{Skill Frozen?}
                    Frozen -->|Yes| Next[Try Next Skill]
                    Frozen -->|No| Improve[Improve Skill Instructions]
                    
                    Improve --> Update[Update Instructions]
                    Update --> Display[Display Changes]
                    Display --> Continue
                    
                    Continue --> CheckEnd{Last Iteration?}
                    CheckEnd -->|No| Loop
                    CheckEnd -->|Yes| Finish([Learning Complete])
                    
                    style Start fill:#27ae60,stroke:#229954
                    style Finish fill:#27ae60,stroke:#229954
                    style Improve fill:#e74c3c,stroke:#c0392b
                    style Update fill:#f39c12,stroke:#d68910
            </div>
        </div>

        <div class="section">
            <h2>5. å¼‚æ­¥æ‰§è¡Œæ¨¡å‹</h2>
            <div class="mermaid">
                sequenceDiagram
                    participant Main as Main Thread
                    participant Agent as Agent
                    participant Env as AsyncEnvironment
                    participant Skills as SkillSet
                    participant RT as AsyncRuntime
                    
                    Main->>Agent: arun
                    Agent->>RT: validate runtime type
                    RT-->>Agent: AsyncRuntime confirmed
                    
                    loop Until Environment Exhausted
                        Agent->>Env: get_data_batch
                        Env-->>Agent: InternalDataFrame
                        
                        Agent->>Skills: aapply
                        Skills->>RT: async batch processing
                        RT-->>Skills: predictions
                        Skills-->>Agent: results
                        
                        Agent->>Env: set_predictions
                        Env-->>Agent: ack
                    end
                    
                    Env-->>Agent: No more data
                    Agent-->>Main: Complete
            </div>
        </div>

        <div class="section">
            <h2>6. é…ç½®ç¤ºä¾‹</h2>
            
            <h3>6.1 åŸºç¡€é…ç½®</h3>
            <div class="code-block">
from adala.agents import Agent
from adala.environments import StaticEnvironment
from adala.skills import LinearSkillSet, TransformSkill

# åˆ›å»ºåŸºç¡€æ™ºèƒ½ä½“
agent = Agent(
    skills=LinearSkillSet(skills=[
        TransformSkill(
            name="classifier",
            instructions="Classify the sentiment of the text",
            input_template="Text: {text}",
            output_template="Sentiment: {sentiment}"
        )
    ]),
    environment=StaticEnvironment(df=dataset)
)

# è¿è¡Œé¢„æµ‹
predictions = agent.run()

# å¯åŠ¨å­¦ä¹ 
agent.learn(
    learning_iterations=3,
    accuracy_threshold=0.9,
    batch_size=100
)
            </div>

            <h3>6.2 é«˜çº§é…ç½®</h3>
            <div class="code-block">
from adala.runtimes import OpenAIChatRuntime, LiteLLMRuntime

# å¤šè¿è¡Œæ—¶é…ç½®
agent = Agent(
    skills=LinearSkillSet(skills=[...]),
    runtimes={
        'fast': OpenAIChatRuntime(
            model='gpt-3.5-turbo',
            temperature=0.7
        ),
        'accurate': OpenAIChatRuntime(
            model='gpt-4',
            temperature=0.1
        ),
        'local': LiteLLMRuntime(
            model='ollama/llama2',
            api_base='http://localhost:11434'
        )
    },
    default_runtime='fast',
    teacher_runtimes={
        'teacher': OpenAIChatRuntime(
            model='gpt-4',
            temperature=0.3
        )
    },
    default_teacher_runtime='teacher'
)
            </div>

            <h3>6.3 å¼‚æ­¥ä½¿ç”¨</h3>
            <div class="code-block">
import asyncio

# å¼‚æ­¥æ‰§è¡Œ
async def process_stream():
    agent = Agent(...)
    
    # æµå¼å¤„ç†
    await agent.arun()
    
    # å•æ‰¹å¤„ç†
    results = await agent.arun(input=data_batch)
    return results

# è¿è¡Œå¼‚æ­¥ä»»åŠ¡
asyncio.run(process_stream())
            </div>
        </div>

        <div class="section">
            <h2>7. æ€§èƒ½ä¼˜åŒ–å»ºè®®</h2>
            <div class="component-grid">
                <div class="component-card">
                    <h3>âš¡ è¿è¡Œæ—¶ä¼˜åŒ–</h3>
                    <ul class="feature-list">
                        <li>åˆç†è®¾ç½® batch_size é¿å…å†…å­˜æº¢å‡º</li>
                        <li>ä½¿ç”¨ concurrency æ§åˆ¶å¹¶è¡Œåº¦</li>
                        <li>é€‰æ‹©åˆé€‚çš„ LLM æ¨¡å‹å¹³è¡¡é€Ÿåº¦å’Œè´¨é‡</li>
                    </ul>
                </div>
                
                <div class="component-card">
                    <h3>ğŸ’° æˆæœ¬æ§åˆ¶</h3>
                    <ul class="feature-list">
                        <li>ä½¿ç”¨è¾ƒå°çš„ batch_size è¿›è¡Œæµ‹è¯•</li>
                        <li>ç›‘æ§ token ä½¿ç”¨é‡</li>
                        <li>è®¾ç½®åˆç†çš„ accuracy_threshold</li>
                    </ul>
                </div>
                
                <div class="component-card">
                    <h3>ğŸ” è°ƒè¯•æŠ€å·§</h3>
                    <ul class="feature-list">
                        <li>å¯ç”¨ verbose æ¨¡å¼æŸ¥çœ‹è¯¦ç»†æ—¥å¿—</li>
                        <li>ä½¿ç”¨ rich æ ¼å¼åŒ–è¾“å‡º</li>
                        <li>åˆ†é˜¶æ®µéªŒè¯æ¯ä¸ªç»„ä»¶</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            themeVariables: {
                primaryColor: '#3498db',
                primaryTextColor: '#2c3e50',
                primaryBorderColor: '#2980b9',
                lineColor: '#7f8c8d',
                secondaryColor: '#ecf0f1',
                tertiaryColor: '#ffffff'
            }
        });
    </script>
</body>
</html>